<!DOCTYPE html>
<html lang="en-US">
<head>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />	
    <title>AVL</title>
	
	<!--Icons (in a folder named "icons")-->
	<link rel="apple-touch-icon" sizes="57x57" href="icons/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="icons/apple-touch-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="icons/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="icons/apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="icons/apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="icons/apple-touch-icon-120x120.png">
	<link rel="icon" type="image/png" href="icons/favicon-32x32.png" sizes="32x32">
	<link rel="icon" type="image/png" href="icons/favicon-96x96.png" sizes="96x96">
	<link rel="icon" type="image/png" href="icons/favicon-16x16.png" sizes="16x16">
	<link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
	<link rel="shortcut icon" href="icons/favicon.ico">
	<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700" rel="stylesheet">


	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<!--<link rel="stylesheet" href="stylesheets/bootstrapMod.css">-->
	<!-- Night modifications for Bootstrap -->
	<link rel="stylesheet" href="stylesheets/bootstrapNight.css?1">
	<!-- Custom Stylesheet -->
    <link rel="stylesheet" href="stylesheets/app_updating.css?2">
	
	<!-- JQUERY for LiveData -->
	<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
	
	<!-- Vue, development version -->
	<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.28/vue.js"></script>-->
	<!-- Vue, min version -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.28/vue.min.js"></script>
	
	<!-- Bootstrap JS -->
	<!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>-->
	
	<!-- VueStrap -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vue-strap/1.1.36/vue-strap.min.js"></script>
	
	<!-- Lodash -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.6.1/lodash.min.js"></script>

	<!-- Vue Google Map -->
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/vue-google-maps/0.1.21/vue-google-maps.js"></script> -->
	<script src="scripts/vue-google-maps-0.1.21.js?1"></script>
	<script src="scripts/misc.js"></script>
	
	<!-- find -->
	<script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=Array.prototype.find,Array.prototype.findIndex,String.prototype.endsWith"></script>
	
	<!-- moment -->
	<script src="scripts/moment.min.js"></script>
	
	<!-- vue-resource -->
	<script src="https://cdn.jsdelivr.net/vue.resource/1.0.3/vue-resource.min.js"></script>
	
	<!-- Security - updated -->
	<script src="http://eservices.cityoflewisville.com/COLSecurity/col_security.js?2"></script>
	
	<!--Google Analytics-->
	<!-- Commented out for beta -->
	<!--https://www.google.com/analytics/web/?authuser=0#realtime/rt-content/a35815214w63720524p65383322/-->
	
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-35815214-5', 'auto');
		ga('send', 'pageview');
	</script>
	
	<!---------------------------------->
	
	<script src="components/zoom-control.js?2"></script>
	<script src="components/traffic-control.js"></script>
	<script src="components/night-control.js"></script>
	<script src="components/center-control.js?1"></script>
	<script src="components/traffic-layer.js"></script>
	<script src="components/kml-layer_32.js"></script>
	<script src="components/map-service-layer.js"></script>
	<script src="components/tile-cache-layer.js"></script>
	<script src="components/wms-layer.js"></script>
	<script src="components/map-service-layer-dark.js"></script>
	
</head>

<body>

<div id="app" class="container-fluid" :class="[{night: nightMode, addClose: showCloseAll}]">
	<navbar placement="top" type="default">
		<span slot="brand">
			<a class="hidden-xs hidden-md navbar-left"><img class="nav-city-logo" alt="Logo" src="/icons/citylogo.svg"/></a>
			<a class="navbar-brand" href="https://docs.google.com/a/cityoflewisville.com/document/d/1fyFM_Zz2n1ar81tByVH5xE-124aMyeCjmmSHLhihFUw/edit?usp=sharing" target="_blank" title="View Instructions">AVL</a>
			
				<button-group :value.sync="radioValue" type="default" class="hidden-lg hidden-md btn-group-med navBtn">
					<radio value="Map">Map</radio>
					<radio value="Both">Both</radio>
					<radio value="List">List</radio>
				</button-group>

				<dropdown slot="right" v-show="(initial1 && initial2)" class="pull-right hide-out-collapse">
					<button slot="button" class="btn btn-link navbar-btn dropdown-toggle" v-show="filterNotes_New.length > 0"><span class="badge">{{filterNotes_New.length}} <span class="caret"></span></span></button>
					<li v-for="call in filterCalls_NewNote"><a v-on:click="clickCallNotification(call)">{{call.complaint}} <span class="badge">{{filterNotesByCallNumber_New(call.callnumber).length}}</span></a></li>
				</dropdown>
				
				<a v-if="(!initial1 || !initial2)" class="pull-right hide-out-collapse"><img class="loading-logo" alt="Loading..." src="/icons/loading.gif"/></a>
				<!--<button slot="button" v-if="isMobile && callsPolling && vehiclesPolling" class="btn btn-link navbar-btn pull-right hide-out-collapse" v-on:click="toggleFullScreen()"><span class="badge"><span class="glyphicon glyphicon-resize-full"></span></span></button>-->
		</span>
	
		<!--<li><a v-on:click="clickCenterMap">Center Map</a></li>-->
		<li v-show="(isMobile && isAndroid)" class="hide-out-collapse" v-bind:class="[{active: mobileFullscreen}]"><a role="button" v-on:click="toggleFullScreen()">Fullscreen <span class="small glyphicon" v-bind:class="[{'glyphicon-resize-full': !(mobileFullscreen), 'glyphicon-resize-small': mobileFullscreen}]"></span></a></li>
		<li v-bind:class="[{active: showNarrative}]"><a role="button" v-on:click="showNarrative=!(showNarrative)">Narrative <span class="small glyphicon" v-bind:class="[{'glyphicon-remove': showNarrative, 'glyphicon-plus': !(showNarrative)}]"></span></a></li>
		<li v-bind:class="[{active: showGIS}]" class="hidden-xs"><a role="button" v-on:click="showGIS=!(showGIS)">GIS Layers <span class="small glyphicon" v-bind:class="[{'glyphicon-remove': showGIS, 'glyphicon-plus': !(showGIS)}]"></span></a></li>
		<!--<li v-bind:class="[{active: showTrafficLayer}]"><a v-on:click="showTrafficLayer=!(showTrafficLayer)">Traffic Layer <span class="small glyphicon" v-bind:class="[{'glyphicon-remove': showTrafficLayer, 'glyphicon-plus': !(showTrafficLayer)}]"></span></a></li>-->
		<li v-bind:class="[{active: showVehicles}]" class="hidden-xs"><a role="button" v-on:click="showVehicles=!(showVehicles)">Vehicles <span class="small glyphicon" v-bind:class="[{'glyphicon-remove': showVehicles, 'glyphicon-plus': !(showVehicles)}]"></span></a></li>
		
		<dropdown text="Filter">
			<li v-bind:class="[{active: showP9}]"><a v-on:click="showP9 = !(showP9)">Priority 9 <span class="glyphicon glyphicon-ok" v-show="showP9"></span></a></li>
			<li class="divider"></li>
			<li class="dropdown-header">Department</li>
			<li class="li-group" v-bind:class="[{active: department == 'ALL'}]"><a v-on:click="department='ALL'">ALL <span class="glyphicon glyphicon-ok" v-show="department == 'ALL'"></span></a></li>
			<li class="li-group" v-bind:class="[{active: department == 'POL'}]"><a v-on:click="department='POL'">POLICE <span class="glyphicon glyphicon-ok" v-show="department == 'POL'"></span></a></li>
			<li class="li-group" v-bind:class="[{active: department == 'FIR'}]"><a v-on:click="department='FIR'">FIRE <span class="glyphicon glyphicon-ok" v-show="department == 'FIR'"></span></a></li>
			<!--<li><a><button-group :value.sync="department" class="btn-group-vertical btn-group-block">
				<radio value='ALL'>ALL</radio>
				<radio value='POL'>POLICE</radio>
				<radio value='FIR'>FIRE</radio>
			</button-group></a></li>-->
		</dropdown>
		<dropdown text="Settings">
			<li class="dropdown-header">Night Mode</li>
			<li class="li-group" v-bind:class="[{active: setNight == 'OFF'}]"><a v-on:click="setNight='OFF'">OFF <span class="glyphicon glyphicon-ok" v-show="setNight=='OFF'"></span></a></li>
			<li class="li-group" v-bind:class="[{active: setNight == 'AUTO'}]"><a v-on:click="setNight='AUTO'">AUTO <span class="glyphicon glyphicon-ok" v-show="setNight=='AUTO'"></span></a></li>
			<li class="li-group" v-bind:class="[{active: setNight == 'ON'}]"><a v-on:click="setNight='ON'">ON <span class="glyphicon glyphicon-ok" v-show="setNight=='ON'"></span></a></li>
			<li v-show="station != ''" class="divider"></li>
			<li v-show="station != ''" class="dropdown-header">Station Alert</li>
			<li v-show="station != ''" class="li-group" v-bind:class="[{active: !(speechAudio)}]"><a v-on:click="speechAudio=false">SOUND <span class="glyphicon glyphicon-ok" v-show="!(speechAudio)"></span></a></li>
			<li v-show="station != ''" class="li-group" v-bind:class="[{active: speechAudio}]"><a v-on:click="speechAudio=true">SPEECH <span class="glyphicon glyphicon-ok" v-show="speechAudio"></span></a></li>
			<li v-if="devITS" class="divider"></li>
			<li v-if="devITS" class="dropdown-header">Call Polling</li>
			<li v-if="devITS" class="li-group" v-bind:class="[{active: callsPollingSec == 5}]"><a v-on:click="callsPollingSec=5">5 sec <span class="glyphicon glyphicon-ok" v-show="callsPollingSec == 5"></span></a></li>
			<li v-if="devITS" class="li-group" v-bind:class="[{active: callsPollingSec == 10}]"><a v-on:click="callsPollingSec=10">10 sec <span class="glyphicon glyphicon-ok" v-show="callsPollingSec == 10"></span></a></li>
			<li v-if="devITS" class="li-group" v-bind:class="[{active: callsPollingSec == 'OFF'}]"><a v-on:click="callsPollingSec='OFF'">OFF <span class="glyphicon glyphicon-ok" v-show="callsPollingSec == 'OFF'"></span></a></li>
			<li v-if="devITS" class="divider"></li>
			<li v-if="devITS" class="dropdown-header">Vehicle Polling</li>
			<li v-if="devITS" class="li-group" v-bind:class="[{active: vehiclesPollingSec == 1}]"><a v-on:click="vehiclesPollingSec=1">1 sec <span class="glyphicon glyphicon-ok" v-show="vehiclesPollingSec == 1"></span></a></li>
			<li v-if="devITS" class="li-group" v-bind:class="[{active: vehiclesPollingSec == 5}]"><a v-on:click="vehiclesPollingSec=5">5 sec <span class="glyphicon glyphicon-ok" v-show="vehiclesPollingSec == 5"></span></a></li>
			<li v-if="devITS" class="li-group" v-bind:class="[{active: vehiclesPollingSec == 10}]"><a v-on:click="vehiclesPollingSec=10">10 sec <span class="glyphicon glyphicon-ok" v-show="vehiclesPollingSec == 10"></span></a></li>
			<li v-if="devITS" class="li-group" v-bind:class="[{active: vehiclesPollingSec == 'OFF'}]"><a v-on:click="vehiclesPollingSec='OFF'">OFF <span class="glyphicon glyphicon-ok" v-show="vehiclesPollingSec == 'OFF'"></span></a></li>
		</dropdown>
		
		<li v-show="station != ''"><a role="button" v-on:click="clickRefresh">Refresh</a></li>
		
		<li v-show="showCloseAll"><a role="button" class="closeAll" v-on:click="clickCloseAll">Close All <span class="small glyphicon glyphicon-remove"></span></a></li>
		
		<dropdown class="hide-in-collapse" v-show="(initial1 && initial2)">
			<button slot="button" type="button" class="btn btn-link navbar-btn dropdown-toggle" v-show="filterNotes_New.length > 0"><span class="badge">{{filterNotes_New.length}} <span class="caret"></span></span></button>
			<li v-for="call in filterCalls_NewNote"><a v-on:click="clickCallNotification(call)">{{call.complaint}} <span class="badge">{{filterNotesByCallNumber_New(call.callnumber).length}}</span></a></li>
		</dropdown>
		
		<dropdown class="hide-in-collapse stationNotification hidden-xs">
			<button slot="button" type="button" class="btn btn-link navbar-btn dropdown-toggle" v-show="filteredCalls_Station.length > 0"><span class="badge">{{station}} <span class="caret"></span></span></button>
			<li v-for="call in filteredCalls_Station"><a v-on:click="clickStationNotification(call)">{{call.complaint}} <span class="badge">{{call.stationUnits}}</span></a></li>
		</dropdown>
		
		<a v-if="(!initial1 || !initial2)" class="hide-in-collapse"><img class="loading-logo" alt="Loading..." src="/icons/loading.gif"/></a>
		
		<!--<li class="dropdown hide-in-collapse" v-show="filterNotes_New.length > 0">
			<a slot="button" class="dropdown-toggle"><span class="badge">{{filterNotes_New.length}} <span class="caret"></span></span></a>
			<ul slot="dropdown-menu" class="dropdown-menu">
				<li v-for="call in filterCalls_NewNote"><a v-on:click="clickCallNotification(call)">{{call.complaint}} <span class="badge">{{filterNotesByCallNumber_New(call.callnumber).length}}</span></a></li>
			</ul>
		</li>-->
		
		<!--<form class="navbar-form input-sm" slot="right"><bs-input type="text" placeholder="Street Address"></bs-input></form>-->
		
		<!--<form class="navbar-form navbar-right input-sm" slot="right">-->
		<div class="form-group form-group-sm hidden-xs" slot="right">
			<place-input v-on:click="resetAutocomplete" class="form-control input-sm" placeholder="Street Address" :select-first-on-enter="true" :component-restrictions.sync="placeInput.restrictions" :place.sync="placeInput.place" :types.sync="placeInput.types" v-ref:gplaceinput>
			</place-input>
		</div>
		<!--</form>-->
			
	</navbar>
	
	<alert :show.sync="showAlert" placement="top" duration="10000" type="warning" width="300px" dismissable>
		<p>Call {{alertCallNumber}} is no longer active</p>
	</alert>
	
	<alert :show="!(callsPolling) || !(vehiclesPolling)" placement="top" type="danger" width="300px" dismissable>
		<p v-if="!(callsPolling)">Polling issues: Calls</p>
		<p v-if="!(vehiclesPolling)">Polling issues: Vehicles</p>
	</alert>
	
	<audio v-el:audio v-show="false" src="1squad51_trim.mp3" preload="auto"></audio>
	
	<div class="row">
		<div class="col-xs-12" v-bind:class="[{'col-sm-12': !(showGIS || showVehicles), 'col-sm-9': (showGIS || showVehicles), 'col-md-10': (showGIS || showVehicles), 'landscape': isLandscape, 'narrative': showNarrative, 'fullLeft': displayToggle=='Map', 'fullRight': displayToggle=='List', 'fireAlert': (stationAlert > 0)}]">
			<div class="row">
				<div id="leftSide" class="col-md-7 col-lg-8" v-bind:class="[{
					'fullScreen': displayToggle=='Map', 'col-xs-6': isLandscape && displayToggle == 'Both'}]">
					<div id="fireAlertDiv" v-if="stationAlert > 0">
						<ul class="list-group">
							<li class="list-group-item list-group-item-danger" v-for="call in filteredCalls_Station_Alert">
								<h1 class="list-group-item-heading">
									{{call.complaint}} - {{call.locationaddr}}
									<span v-if="call.stationUnits2.length == 0"><span class="badge" v-for="unit in call.stationUnits">{{unit}}</span></span>
									<span v-if="call.stationUnits2.length > 0"><span class="badge" v-for="unit in call.stationUnits2">{{unit.unit}}<span v-if="unit.isNew"> *new*</span></span></span>
								</h1>
							</li>
						</ul>
					</div>
					<div id="mapDiv" v-show="displayToggle != 'List'">
<!-- UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 remove from map v-on:g-idle="resizeMap"-->
						<map v-if="mapLoaded" :center.sync="centerV" :zoom.sync="zoomV" :bounds.sync="mapBounds" :options="mapOptions" v-on:g-idle="mapIdling" id="map" v-ref:map>
						
							<zoom-control></zoom-control>
							<traffic-control></traffic-control>
							<center-control></center-control>
							
							<marker v-if="placeInput.place.id" :position.sync="placeInput.place.geometry.location" :clickable.sync="true" :draggable.sync="false" :icon="getSearchIcon()" :label="getSearchLabel()" :z-index="1600">
								<info-window :opened.sync="placeInputOpen" :z-index="1600">
									<span>
										{{placeInput.place.formatted_address}}
									</span>
								</info-window>
							</marker>
							
							<!-- accounts for up to 200 vehicles -->
							<marker v-for="vehicle in mappableVehicles" track-by="modemid" :position="getLatLng(vehicle.lat, vehicle.lng)" :clickable.sync="true" :draggable.sync="false" :icon="getVehicleIcon(vehicle)" :label="getVehicleLabel(vehicle)" @g-click="clickVehicleMarker(vehicle, $event)" :z-index="getVehicleIndex(vehicle)"> <!--:z-index="getVehicleIndex(vehicle)"-->
								<info-window class="iwStyle" :opened.sync="vehicle.isOpen" :z-index="getVehicleIndex(vehicle)">
									<b class="pull-left" style="margin-bottom:10px;">{{vehicle.label}}</b>
									<table class="table table-condensed">
										<tr v-if="vehicle.vin.length > 0">
											<td><small>GPS ID:</small></td><td title="TrackStar ID: {{vehicle.vehicleid}}"><small>{{vehicle.vin}}</small></td>
										</tr>
										<tr v-if="vehicle.unitid">
											<td><small>Officer:</small></td><td><small>{{vehicle.officername ? vehicle.officername : vehicle.officerids}}</small></td>
										</tr>
										<tr v-if="vehicle.division1">
											<td><small>Division:</small></td><td><small>{{vehicle.division1}}<span v-if="vehicle.division2"> - {{vehicle.division2}}</span></small></td>
										</tr>
										<tr v-if="vehicle.callcomplaint">
											<td><small>Complaint:</small></td><td><b><small>{{vehicle.callcomplaint.toUpperCase()}}&nbsp;<small>({{vehicle.tenstatus}})</small></span></small></b></td>
										</tr>
										<tr v-if="vehicle.callstreet">
											<td><small>Call Street:</small></td><td><small>{{vehicle.callstreet}}</small></td>
										</tr>
										<tr><td><small>Est Speed:</small></td><td><small>{{vehicle.velocity}}mph&nbsp;{{vehicle.compass}} {{getBearingArrow(vehicle.compass)}}</small></td></tr>
									</table>
									
								</info-window>
							</marker>
							
							<!--  accounts for up to 200 calls -->
							<marker v-for="call in mappableCalls" track-by="callnumber" :position="getLatLng(call.lat2, call.lng2)" :clickable.sync="true" :draggable.sync="false" :icon="getCallIcon(call.isOpen)" :label="getCallLabel(call.complaint, call.isnew)" @g-click="clickCallMarker(call, $event)" :z-index="getCallIndex(call)">
								<info-window :opened.sync="call.isOpen" :z-index="getCallIndex(call)">
									<b>{{call.complaint}}</b>
									<br>
									<small>{{call.locationaddr}}</small>
								</info-window>
							</marker>
							
							<traffic-layer v-if="showTrafficLayer"></traffic-layer>
							<kml-layer v-if="mapBoundsSet2" v-for="lyr in filterLayersByFiletype('kml')" :layer.sync="lyr"></kml-layer>
							<map-service-layer v-if="mapBoundsSet2" v-for="lyr in filterLayersByFiletype('mapservice')" :layer.sync="lyr"></map-service-layer>
							<tile-cache-layer v-if="mapBoundsSet2" v-for="lyr in filterLayersByFiletype('tilecache')" :layer.sync="lyr"></tile-cache-layer>
							<!--<wms-layer v-if="mapBoundsSet2" v-for="lyr in filterLayersByFiletype('wms')" :layer.sync="lyr"></wms-layer>-->
							<map-service-layer-dark v-if="mapBoundsSet2" v-for="lyr in filterDarkLayersByFiletype('mapservice')" :layer.sync="lyr"></map-service-layer-dark>
						</map>
					</div>
					<div id="narrativeFeed" v-if="showNarrative">
						<table class="table table-striped table-hover table-condensed" :class="[{'small': station==''}]">
							<tbody>
								<tr v-for="note in filterNotes_Feed" v-on:click="clickNarrativeFeed(note.callnumber)" v-bind:class="[{'success': note.isnew}]">
									<td>{{note.complaint}}</td>
									<td><small>{{note.callnumber}}</small></td>
									<td>{{note.narrative}}</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
				<div id="rightSide" class="col-md-5 col-lg-4" v-show="displayToggle != 'Map'" v-bind:class="[{
					'fullScreen': displayToggle=='List', 'col-xs-6': isLandscape && displayToggle == 'Both'}]">
					<div v-if="(!initial1)">
						<img class="loading-logo center-block" alt="Loading..." src="/icons/loading.gif"/>
					</div>
					<div id="listDiv">
						<accordion id="list" v-ref:accordion>
							<panel v-for="call in sortedCalls" track-by="callnumber" :is-open.sync="call.isOpen" v-on:click="clickCallList(call, $event)" :type="call.isnew ? 'success' : 'default'" id="{{call.callnumber}}">
								<span slot="header">
									<span v-if="call.unitcount > 3" style="color:red;font-size: 0.9em;">*</span>
									<strong>{{call.complaint}}</strong><small>  P{{call.priority}}</small><small class="pull-right">{{call.timereceived.substr(0,5)}}</small>
									&nbsp;
									<!--<span class="label label-success" v-show="call.isnew">New</span>-->
									<span class="badge" v-show="filterNotesByCallNumber_New(call.callnumber).length > 0">{{filterNotesByCallNumber_New(call.callnumber).length}} New</span>
									<br>
									<small>{{call.locationaddr}}&nbsp;({{ (call.units) }})</small>
									<span class="badge small pull-right stationBadge" v-if="call.stationUnits.length > 0">{{station}}</span>
								</span>
								<span>
									<ul class="list-unstyled">
										<li>Call Number: {{call.callnumber}}</li>
										<li>Location: {{call.locationaddr}}</li>
										<li>Lat/Lng: {{call.lat ? call.lat : '???'}}, {{call.lng ? call.lng : '???'}}</li>
										<li>Time Received: {{call.timereceived}}</li>
										<li v-if="call.landmark">Landmark: {{call.landmark}}</li>
										<li>Department: {{call.department}}</li>
										<li>Priority: {{call.priority}}</li>
										<li v-if="filterVehiclesByCallUnits(call.units).length > 0">Map Units: <button type="button" v-for="unit in filterVehiclesByCallUnits(call.units)" class="btn btn-link btn-xs" v-on:click.stop="clickVehicleList(unit)">{{unit.label}}</button></li>
									</ul>
									<table class="table table-striped table-condensed table-bordered small">
										<tbody>
											<tr v-for="note in filterNotesByCallNumber(call.callnumber)" track-by="pkey" v-bind:class="[{'success': note.isnew}]">
												<td>{{note.narrative}}</td>
											</tr>
										</tbody>
									</table>
								</span>
							</panel>
						</accordion>
					</div>
				</div>
			</div>
		</div>
		<div v-show="showGIS || showVehicles" class='col-sm-3 col-md-2 hidden-xs' id="extraPanel">
			<div v-show="showGIS" id="layersList">
				<div v-show="chooseGIS == 'GISLayers'">
					<accordion>
						<panel v-for="group in groups" :header="group.name">
							<span>
								<table class="table table-condensed table-hover layersTable">
									<tbody>
										<tr v-for="lyr in filterLayersByGroup(group.id)">
											<td v-on:click="layerToggle(lyr)" colspan="{{lyr.legendshow ? '1': '2'}}" class="layerCell"> <!--v-bind:class="[{'invalidFileType': !(lyr.isValidFileType)}]"-->
												<small><span class="glyphicon" v-bind:class="[{'glyphicon-plus': !(lyr.active), 'glyphicon-ok': lyr.active}]"></span></small> <!--'glyphicon-ban-circle': !(lyr.isValidFileType)-->
												{{lyr.label}}
												<span class="glyphicon glyphicon-refresh gly-spin" v-if="lyr.isloading"></span>
											</td>
											<td v-if="lyr.legendshow" class="legendCell">
												<button class="btn btn-default btn-xs pull-right" v-if="lyr.active == true && (lyr.legend.length > 0)" v-on:click="chooseGIS = lyr.label"><span class="glyphicon glyphicon-menu-hamburger"></span></button>
											</td>
										</tr>
									</tbody>
								</table>
							</span>
						</panel>
					</accordion>
					<button class="btn btn-xs btn-danger pull-right reloadGISButton" v-on:click="loadGISLayers()">Reload GIS Layers</button>
				</div>
				<div v-show="chooseGIS != 'GISLayers'">
					<div v-for="lyr in filterLayers_Legend" v-show="chooseGIS == lyr.label">
						<h4 class="legendTitle"><button class="btn btn-xs btn-default" v-on:click="chooseGIS = 'GISLayers'"><span class="glyphicon glyphicon-remove"></span></button>{{lyr.label}} <small>LEGEND</small></h4>
						<table class="table">
							<thead>
								<tr>
									<th>Symbol</th>
									<th>Value</th>
								</tr>
							</thead>
							<tbody>
								<tr v-for="item in lyr.legend">
									<td><img v-bind:src="'data:' + item.contentType + ';base64,' + item.imageData" v-bind:height="item.height" v-bind:width="item.width"/></td>
									<td>{{item.label}}</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
			<div v-show="showVehicles" id="vehicleList">
				<accordion>
					<panel header="Police">
						<span>
							<a class="list-group-item" v-for="vehicle in filterVehicles_Police" v-on:click="clickVehicleList(vehicle, $event)">
								<h5 class="list-group-item-heading"><strong>{{vehicle.vin}}</strong>  <span v-if="!(vehicle.isrecent)" class="glyphicon glyphicon-time"></span></h5>
								
									<ul class="list-group-item-text list-unstyled" v-if="vehicle.isOpen">
										<li v-if="vehicle.unitid">Unit ID: {{vehicle.unitid}}</li>
										<li v-if="vehicle.division1">Division: {{vehicle.division1}}<span v-if="vehicle.division2"> - {{vehicle.division2}}</span></li>
										<li v-if="vehicle.unitid">Officer: {{vehicle.officername ? vehicle.officername : vehicle.officerids}}</li>
										<li v-if="vehicle.callnumber">Call Number: {{vehicle.callnumber}}</li>
										<li v-if="vehicle.callnumber">Complaint: {{vehicle.callcomplaint}}</li>
										<li v-if="!(vehicle.isrecent)">Last Ping: {{vehicle.latlngtime}}</li>
										<li>TrackStar ID: {{vehicle.vehicleid}}</li>
									</ul>
							</a>
						</span>
					</panel>
					<panel header="Fire">
						<span>
							<a class="list-group-item" v-for="vehicle in filterVehicles_Fire" v-on:click="clickVehicleList(vehicle, $event)">
								<h5 class="list-group-item-heading"><strong>{{vehicle.label}}</strong>  <span v-if="!(vehicle.isrecent)" class="glyphicon glyphicon-time"></span></h5>
								
									<ul class="list-group-item-text list-unstyled" v-if="vehicle.isOpen">
										<li v-if="vehicle.unitid">GPS ID: {{vehicle.vin}}</li>
										<li v-if="vehicle.division1">Division: {{vehicle.division1}}<span v-if="vehicle.division2"> - {{vehicle.division2}}</span></li>
										<li v-if="vehicle.unitid">Officer: {{vehicle.officername ? vehicle.officername : vehicle.officerids}}</li>
										<li v-if="vehicle.callnumber">Call Number: {{vehicle.callnumber}}</li>
										<li v-if="vehicle.callnumber">Complaint: {{vehicle.callcomplaint}}</li>
										<li v-if="!(vehicle.isrecent)">Last Ping: {{vehicle.latlngtime}}</li>
										<li>TrackStar ID: {{vehicle.vehicleid}}</li>
									</ul>
							</a>
						</span>
					</panel>
					<panel header="Fire Prevention">
						<span>
							<a class="list-group-item" v-for="vehicle in filterVehicles_FirePrevention" v-on:click="clickVehicleList(vehicle, $event)">
								<h5 class="list-group-item-heading"><strong>{{vehicle.label}}</strong>  <span v-if="!(vehicle.isrecent)" class="glyphicon glyphicon-time"></span></h5>							
									<ul class="list-group-item-text list-unstyled" v-if="vehicle.isOpen">
										<li>Radio ID: {{vehicle.vin}}</li>
										<li v-if="!(vehicle.isrecent)">Last Ping: {{vehicle.latlngtime}}</li>
										<li>TrackStar ID: {{vehicle.vehicleid}}</li>
									</ul>
								
							</a>
						</span>
					</panel>
				</accordion>
			</div>
		</div>
	</div>
</div>


<script>

if(window.speechSynthesis){window.speechSynthesis.cancel();}

VueGoogleMap.load({
	key: getMapAPI(),
	v: '3.32',
	libraries: 'places,drawing',
});

Vue.component('navbar', VueStrap.navbar);
Vue.component('accordion', VueStrap.accordion);
Vue.component('panel', VueStrap.panel);
Vue.component('radio', VueStrap.radio);
Vue.component('button-group', VueStrap.buttonGroup);
Vue.component('dropdown', VueStrap.dropdown);
Vue.component('checkbox', VueStrap.checkbox);
Vue.component('alert', VueStrap.alert);
Vue.component('bsinput', VueStrap.input);
Vue.component('map', VueGoogleMap.Map);
Vue.component('marker', VueGoogleMap.Marker);
Vue.component('cluster', VueGoogleMap.Cluster);
Vue.component('info-window', VueGoogleMap.InfoWindow);
Vue.component('place-input', VueGoogleMap.PlaceInput);
	
var app = new Vue({
	el: '#app',
	data: {
		callsPolling: true,
		callsPollingSec: 10,
		vehiclesPolling: true,
		vehiclesPollingSec: 1,
		initial1: false,
		initial2: false,
		data: {Calls: [], Notes: []},
		data2: {Vehicles:[]},
		layers: [],
		layersToggleOrder: [],
		layersMapTypeOrder: [],
		countActiveLayers: 0,	// what what this going to be used for?
		
		datenow: '',
		
		/* map variables */
		centerV: {lat: 33.04874516100256, lng: -96.9571323598633},
		zoomV: 13,
		mapBounds: {},	// is this anything
		centerDefault: {lat: 33.04874516100256, lng: -96.9571323598633},
		
		countOpenIndex: 1600, 
		
		/* views */
		radioValue: 'Both',
		// GIS layers
		showGIS: false,
		chooseGIS: 'GISLayers',
		showVehicles: false,
		/* options */
		showTrafficLayer: false,
		setNight: 'OFF',
		nightMode: false,
		/* filters */
		department: 'ALL',
		showNarrative: false,
		showP9: true,
		station: '',
		
		speechAudio: false,
		voiceUK: '',
		complaintAudio: {},
		complaintAudioFound: false,
		stationAudio: '',
		timeoutStationAlert: '',
		speechQueue: [],
		currentlySpeaking: false,
		
		devITS: false,
		
		// initial load for Call Number as parameter
		alertCallNumber: '',
		showAlert: false,
		
		// input
		placeInputOpen: false,
		placeInput: {place:{name:''}, types: [], restrictions: {'country':'us'}},
		
		fullHeight: document.documentElement.clientHeight,
		fullWidth: document.documentElement.clientWidth,
		isMobile: false,
		isAndroid: false,
		mobileFullscreen: false,
		
		/* TRYING TO FIX CENTERING ISSUE */
		mapLoaded: false,
		mapBoundsSet: false,
		mapBoundsSet2: false,
		centerSW: {lat: 33.009298, lng: -97.036123},
		centerNE: {lat: 33.071864, lng: -96.893458},
		
			
		/*mapstyle*/
		night: [
			{elementType: 'geometry', stylers: [{color: '#000000'}]},
			{elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
			{elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
			{featureType: 'administrative.locality', elementType: 'labels.text.fill', stylers: [{color: '#d59563'}]},
			{featureType: 'poi', elementType: 'labels.text.fill', stylers: [{color: '#d59563'}]},
			{featureType: 'poi.park', elementType: 'geometry', stylers: [{color: '#1a331a'}]},
			{featureType: 'poi.park', elementType: 'labels.text.fill', stylers: [{color: '#3c763d'}]},
			{featureType: 'poi.park', elementType: 'labels.text.stroke', stylers: [{visibility: 'off'}]},
			{featureType: 'road', elementType: 'geometry', stylers: [{color: '#38414e'}]},
			{featureType: 'road', elementType: 'geometry.stroke', stylers: [{color: '#212a37'}]},
			{featureType: 'road', elementType: 'labels.text.fill', stylers: [{color: '#9ca5b3'}]},
			{featureType: 'road.highway', elementType: 'geometry', stylers: [{color: '#746855'}]},
			{featureType: 'road.highway', elementType: 'geometry.stroke', stylers: [{color: '#1f2835'}]},
			{featureType: 'road.highway', elementType: 'labels.text.fill', stylers: [{color: '#f3d19c'}]},
			{featureType: 'transit', elementType: 'geometry', stylers: [{color: '#2f3948'}]},
			{featureType: 'transit.station', elementType: 'labels.text.fill', stylers: [{color: '#d59563'}]},
			{featureType: 'water', elementType: 'geometry', stylers: [{color: '#0d1d26'}]},
			{featureType: 'water', elementType: 'labels.text.fill', stylers: [{color: '#31708f'}]},
			{featureType: 'water', elementType: 'labels.text.stroke', stylers: [{visibility: 'off'}]}
		],
	},
	watch:{
		mapBounds: function(newVal, oldVal){
			if(newVal){
				this.mapBoundsSet = true;
				//console.log(newVal.getSouthWest().lng() + ', ' + newVal.getNorthEast().lng());
			}
		},
		mapBoundsSet: function(newVal, oldVal){
			//console.log("mbs");
			if(!oldVal && newVal){
				//console.log('bub');
				this.mapBoundsSet2 = true;
			}
		},
		mapLoaded: function(newVal, oldVal){
			//console.log("mapLoaded");
		},
		showTrafficLayer: function(newVal, oldVal){
			if (newVal != oldVal){
				if(newVal){
					$("#traffic").addClass("controlBold");
				}
				else{
					$("#traffic").removeClass("controlBold");
				}
			}
		},
		setNight: function(newVal, oldVal){
			if (newVal != oldVal){
				if (newVal == 'OFF'){
					this.nightMode = false;
				}
				else if (newVal == 'ON'){
					this.nightMode = true;
				}
				else if (newVal == 'AUTO'){
					this.setDate();
				}
			}
		},
		'placeInput.place': function(newVal, oldVal){
			//console.log("PLACECHANGE");
			if (newVal.name != oldVal.name){
				if(newVal.name){
					if (this.zoomV < 15){
						this.zoomV = 15;
					}
					//console.log("centerV PLACECHANGE");
					this.centerV = newVal.geometry.location;
					this.placeInputOpen = true;
				}
			}
		},
		filteredCalls_Station: {
			handler: function(newArr, oldArr){
				// FUTURE REF: Probably should have used a component for each call that watches for changes on itself and emitts an event to parent (in app)
				//console.log('watch');
				
				var newCenter = false;
				var playAudio = false;
				var matchU;
				var matchCallNum;
				var newUnits;
				var stationUnits2;
				
				if(newArr.length > 0){
					//console.log("filteredCalls_Station Change");
					
					// for each call in new array
					newArr.forEach(function(callN, index){
						// reset variables
						matchCallNum = false;
						newUnits = [];
						stationUnits2 = [];
							
						// for each call in old array: check if the new call has a matching old call
						if(oldArr.length > 0){
							oldArr.forEach(function(callO){
								// If callnumber already matched, skip
								if(!(matchCallNum)){
								
									// check if callnumber matches
									if(callN.callnumber == callO.callnumber){
										matchCallNum = true;
										
										// if so, check if units are the same
										// for each unit in new call's array
										callN.stationUnits.forEach(function(unitN){
											// check old call's array for matching unit
											matchU = callO.stationUnits.findIndex(function(unitO){
												return unitN == unitO;
											});
											// if old array did not contain unit, add it to newUnits array
											if(matchU == -1){
												//console.log('new unit');
												newUnits.push(unitN);
												stationUnits2.push({'unit': unitN, 'isNew': true})
											}
											else{
												//console.log('not new unit');
												stationUnits2.push({'unit': unitN, 'isNew': false})
											}
										});
									}
								}
							});
						}
						
						// if call is new, need to play alert with all call information
						if(!(matchCallNum)){
							callN.newUnits = newUnits;
							callN.stationUnits2 = stationUnits2;
							callN.showAlert = true;
							if(app.speechAudio){
								app.speechQueue.push(callN);
							}
							playAudio = true;
							callN.alertTimeout = setTimeout(app.clearStationAlert.bind(null,callN.callnumber),60000);
							newCenter = true;
						}
						
						// if previous call has new units, 
						else if(newUnits.length > 0){
							callN.newUnits = newUnits;
							callN.stationUnits2 = stationUnits2;
							if(callN.showAlert){
								clearTimeout(callN.alertTimeout);
							}
							callN.showAlert = true;
							if(app.speechAudio){
								app.speechQueue.push(callN);
							}
							playAudio = true;
							callN.alertTimeout = setTimeout(app.clearStationAlert.bind(null,callN.callnumber),60000);
							newCenter = true;
						}
					});
					var newArrOpen = newArr.filter(function(call){return call.isOpen;});
					var newArrOpenN = newArrOpen.filter(function(call){return call.isnew;});
					if(playAudio){
						if(!(app.currentlySpeaking)){
							app.playStationAlert();
						}
						if (newArrOpen.length > 0){
							app.centerOnCall(newArrOpen[0]);
						}
					}
					else if(!(newCenter)){
						//console.log("No change to Station Calls");
						// reset center to top call for station
						if(newArrOpenN.length > 0){
							app.centerOnCall(newArrOpenN[0]);
						}
						else if (newArrOpen.length > 0){
							app.centerOnCall(newArrOpen[0]);
						}
						else{
/* UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 */
//comment out							app.$broadcast('g-resize-map');
							app.clickCenterMap();
						}
					}
				}
				else if (newArr.length == 0 && oldArr.length != 0){
/* UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 */
//comment out		app.$broadcast('g-resize-map');
					app.clickCenterMap();
				}
			},
			deep: true
		},
		stationAlert: function(newVal, oldVal){
			//console.log(oldVal + ' -> ' + newVal);
			if (newVal != oldVal){
				//console.log('watch2');
/* UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 */
//comment out	this.$broadcast('g-resize-map');
				if(newVal){
					//console.log('stationAlert changed true');
					//this.$els.audio.play();
					//setTimeout(app.playStationAlert.bind(null,app.filteredCalls_Station_Alert),3000);
					/*if(!(this.speechAudio)){
						this.$els.audio.play();
					}
					else{
						this.playStationAlert(app.filteredCalls_Station_Alert);
					}
					setTimeout(function(){
						//console.log("click");
						app.clickStationNotification(app.filteredCalls_Station_Alert[0]);
					}, 1000);*/
				}
				else{
					
				}
			}
		},
	},
	computed: {
		currentRoute: function(){
			var route = '';

			// Views
			
			if(this.radioValue != 'Both'){
				route += 'view=' + this.radioValue.toLowerCase();
			}
			if(this.showNarrative){
				if(this.radioValue != 'Both'){
					route += '&';
				}
				route += 'narrative';
			}
			if(this.showGIS){
				if( this.radioValue != 'Both' || this.showNarrative){
					route += '&';
				}
				route += 'layers';
			}
			if(this.showVehicles){
				if( this.radioValue != 'Both' || this.showNarrative || this.showGIS ){
					route += '&';
				}
				route += 'vehicles';
			}
			
			// Options
			
			if(this.showTrafficLayer){
				if( this.radioValue != 'Both' || this.showNarrative || this.showGIS || this.showVehicles ){
					route += '&';
				}
				route += 'traffic';
			}
		
			// Filters
			
			if(this.department != 'ALL'){
				if( this.radioValue != 'Both' || this.showNarrative || this.showGIS || this.showVehicles || this.showTrafficLayer ){
					route += '&';
				}
				
				if(this.department == 'POL'){
					route += 'department=police';
				}
				else{
					route += 'department=fire';
				}
			}
			if(!(this.showP9)){
				if( this.radioValue != 'Both' || this.showNarrative || this.showGIS || this.showVehicles || this.showTrafficLayer || this.department != 'ALL' ){
					route += '&';
				}
				route += 'xp9';
			}
			if(this.station != ''){
				if( this.radioValue != 'Both' || this.showNarrative || this.showGIS || this.showVehicles || this.showTrafficLayer || this.department != 'ALL' || !(this.showP9) ){
					route += '&';
				}
				
				route += 'station=' + this.station.toLowerCase();
			}
			
			if(this.setNight != 'OFF'){
				if( this.radioValue != 'Both' || this.showNarrative || this.showGIS || this.showVehicles || this.showTrafficLayer || this.department != 'ALL' || !(this.showP9) || this.station != '' ){
					route += '&';
				}
				route += 'night=' + this.setNight.toLowerCase();
			}
			
			if(this.speechAudio){
				if( this.radioValue != 'Both' || this.showNarrative || this.showGIS || this.showVehicles || this.showTrafficLayer || this.department != 'ALL' || !(this.showP9) || this.station != '' || this.setNight != 'OFF'){
					route += '&';
				}
				route += 'speech';
			}
			
			if(this.devITS){
				if( this.radioValue != 'Both' || this.showNarrative || this.showGIS || this.showVehicles || this.showTrafficLayer || this.department != 'ALL' || !(this.showP9) || this.station != '' || this.setNight != 'OFF' ){
					route += '&';
				}
				route += 'developer';
			}
			
			/*
			if(this.callsPollingSec != 10){
				if( this.radioValue != 'Both' || this.showNarrative || this.showGIS || this.showVehicles || this.showTrafficLayer || this.department != 'ALL' || !(this.showP9) || this.station != '' || this.setNight != 'OFF' || this.devITS ){
					route += '&';
				}
				if(this.callsPollingSec == 'OFF'){
					route += 'callpoll=' + this.callsPollingSec.toLowerCase();
				}
				else {
					route += 'callpoll=' + this.callsPollingSec;
				}
			}
			if(this.vehiclesPollingSec != 5){
				if( this.radioValue != 'Both' || this.showNarrative || this.showGIS || this.showVehicles || this.showTrafficLayer || this.department != 'ALL' || !(this.showP9) || this.station != '' || this.setNight != 'OFF' || this.devITS || this.callsPollingSec != 10 ){
					route += '&';
				}
				if(this.vehiclesPollingSec == 'OFF'){
					route += 'vehiclepoll=' + this.vehiclesPollingSec.toLowerCase();
				}
				else {
					route += 'vehiclepoll=' + this.vehiclesPollingSec;
				}
			}
			*/
			
			return route;
		},
	
		isLandscape: function(){
			return (this.fullWidth > this.fullHeight);
		},
		isStacked: function(){
			return (this.fullWidth <= 991 );
		},
		
		displayToggle: function(){
			if(this.isStacked){
				return this.radioValue;
			}
			else{
				return 'Both';
			}
		},
		
		mapOptions: function(){
			if(!(this.nightMode)){
				return{zoomControl: false, fullscreenControl: false, streetViewControl: true, gestureHandling: 'greedy', styles: null, tilt:0};
			}
			else{
				return{zoomControl: false, fullscreenControl: false, streetViewControl:true, gestureHandling: 'greedy', styles: this.night, tilt:0};
			}
		},
		
		callsPollingMS: function(){
			if (this.callsPollingSec == 'OFF'){
				return 'OFF';
			}
			else{
				return this.callsPollingSec * 1000;
			}
		},
		
		vehiclesPollingMS: function(){
			if (this.vehiclesPollingSec == 'OFF'){
				return 'OFF';
			}
			else{
				return this.vehiclesPollingSec * 1000;
			}
		},
		
		filteredCalls: function(){
			var self = this;
			
			// Filter Priority 9
			var c; 
			if(this.showP9){
				c = this.data.Calls;
			}
			else{
				c = this.data.Calls.filter(function(call){
					return call.priority != 9;
				});
			}
			
			// Filter Department
			if (this.department == 'ALL'){
				return c;
			}
			else{
				return c.filter(function(call){
					return call.department == self.department || call.department == 'ALL';
				});
			}
		},
		filteredNotes: function(){
			var self = this;
			
			// Filter Priority 9
			var n; 
			if(this.showP9){
				n = this.data.Notes;
			}
			else{
				n = this.data.Notes.filter(function(note){
					return note.priority != 9;
				});
			}
			
			// Filter Department
			if (this.department == 'ALL'){
				return n;
			}
			else{
				return n.filter(function(note){
					return note.department == self.department || note.department == 'ALL';
				});
			}
		},
		filteredVehicles: function(){
			var self = this;
			if (this.department == 'ALL'){
				return this.data2.Vehicles;
			}
			else{
				return this.data2.Vehicles.filter(function(vehicle){
					return vehicle.department == self.department;
				});
			}
		},
		sortedCalls: function(){
			return this.filteredCalls.sort(function(a, b){
				return a.order - b.order;
			});
		},
		mappableCalls: function(){
			return this.filteredCalls.filter(function (call) {
				return !(!(call.lat) || !(call.lng));
			});
		},
		mappableVehicles: function(){
			return this.filteredVehicles.filter(function (vehicle) {
				return !(!(vehicle.lat) || !(vehicle.lng));
			});
		},
		
		filteredCalls_Station: function(){
			//var c = [];
			if(this.station != ''){
				return this.filteredCalls.filter(function(call){
					return (call.unitcount > 0 && call.stationUnits.length > 0); // cannot restrict to FIR
				});
			}
			else{
				return [];
			}
		},
		filteredCalls_Station_Alert: function(){
			return this.filteredCalls_Station.filter(function(call){
				return call.showAlert;
			});
		},
		stationAlert: function(){
			return this.filteredCalls_Station_Alert.length;
		},
		
		showCloseAll: function(){
			// determine if more than 1 call open, show/hide close all button
			var c = this.filteredCalls.filter(function(call){
				return call.isOpen;
			});
			var v = this.filteredVehicles.filter(function(vehicle){
				return vehicle.isOpen;
			});
			if(c && v){
				return ((c.length + v.length) > 1);
			}
			else if(c){
				return (c.length > 1);
			}
			else if(v){
				return (v.length > 1);
			}
			else{
				return false;
			}
		},
		filterVehicles_Police: function(){
			return this.data2.Vehicles.filter(function(vehicle){
				return vehicle.department == 'POL';
			}).sort(function(a,b){
				if(a.vin == b.vin){
					return a.label - b.label;
				}
				return a.vin - b.vin;
			});
		},
		filterVehicles_Fire: function(){
			return this.data2.Vehicles.filter(function(vehicle){
				return vehicle.department == 'FIR' && vehicle.division1 != 'PREVENTION';
			}).sort(function(a,b){
				return a.label - b.label;
			});
		},
		filterVehicles_FirePrevention: function(){
			return this.data2.Vehicles.filter(function(vehicle){
				return vehicle.department == 'FIR' && vehicle.division1 == 'PREVENTION';
			}).sort(function(a,b){
				return a.label - b.label;
			});
		},
		filterCalls_NewNote: function(){
			return this.filteredCalls.filter(function(call){
				return call.isnew;
			});
		},
		filterNotes_New: function(){
			return this.filteredNotes.filter(function(note){
				return note.isnew; 
			});
		},
		filterNotes_Feed: function(){
			var notesNew = [];
			var notesExtra = [];
			notesNew = this.filteredNotes.filter(function(note){
				return note.isnew2; 
			});
			if(notesNew.length < 10){
				notesExtra = this.filteredNotes.filter(function(note){
					return !(note.isnew2); 
				}).sort(function(a, b){
					return a.order - b.order;
				}).slice(0, (10 - notesNew.length) );
			}
			return notesNew.concat(notesExtra).sort(function(a,b){
				return a.order - b.order;
			});
		},
		filterLayers_Active: function(){
			return this.layers.filter(function(lyr){
				return (lyr.active == true);
			}).sort(function(a, b){
				return a.toggleOrder - b.toggleOrder;
			});
		},
		filterLayers_Legend: function(){
			return this.filterLayers_Active.filter(function(lyr){
				return (lyr.filetype.toLowerCase() == 'mapservice' && lyr.legendshow && lyr.legend );
			}).sort(function(a, b){
				return a.toggleOrder - b.toggleOrder;
			});
		},
		groups: function() {
			g = this.layers.map(function(obj) { 
				return {
					id: obj.groupid, 
					name: obj.groupname, 
					order: obj.grouporder
				};
			});
			
			newArr = [];
			origLen = g.length;
			found = false;
			x = 0;
			y = 0;
			for (x = 0; x < origLen; x++) {
				found = false;
				for (y = 0; y < newArr.length; y++) {
					if (g[x].id === newArr[y].id) {
						found = true;
						break;
					}
				}
				if (!found) {
					newArr.push(g[x]);
				}
			}
			return newArr.sort(function(a, b){ return a.order - b.order});
		}
	},
	methods:{
		handleResize: function(event) {
/* UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 */
			this.fullHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
			this.fullWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
		},
/* UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 */
/*comment out		resizeMap: function(){
			this.$broadcast('g-resize-map');
		},*/
		mapIdling: function(){
			//console.log("idling " + this.mapBounds.getSouthWest().lng() + ', ' + this.mapBounds.getNorthEast().lng());
			//this.$broadcast('g-resize-map');
		},
		toggleFullScreen: function() {
		
			var doc = window.document;
			var docEl = doc.documentElement;
			var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
			var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;
			if(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
				requestFullScreen.call(docEl);
				this.mobileFullscreen = true;
			}
			else {
				cancelFullScreen.call(doc);
				this.mobileFullscreen = false;
			}
		},
		
		setDate: function(){
			var self = this;
			
			if(self.setNight == 'AUTO'){
				self.datenow = moment();
				
				if (self.datenow.second() > 0){
					setTimeout(self.setDate, 1000);
				}
				else{
					setTimeout(self.setDate, 60000);
				}
				
				if(self.datenow.hour() > 19 || self.datenow.hour() < 8){
					self.nightMode = true;
				}
				else{
					self.nightMode = false;
				}
			}
		},
		
		filterVehiclesByCallUnits: function(units){
			var u = units.split(', ');
			return this.mappableVehicles.filter(function(vehicle){
				if(vehicle.department == 'FIR'){
					return (u.indexOf(vehicle.vinjoin) > -1);
				}
				else{
					return (u.indexOf(vehicle.label) > -1);
				}
			});
		},

		filterNotesByCallNumber: function(callnumber){
			return this.filteredNotes.filter(function(note){
				return note.callnumber == callnumber;
			}).sort(function(a,b){
				return b.order - a.order;
			});
		},
		filterNotesByCallNumber_New: function(callnumber){
			return this.filteredNotes.filter(function(note){
				return note.callnumber == callnumber && note.isnew; 
			});
		},
		
		filterLayersByFiletype: function(type){
			var self = this;
			return this.filterLayers_Active.filter(function(lyr){
				return lyr.filetype.toLowerCase() == type && !(self.nightMode && lyr.urldark);
			});
		},
		filterDarkLayersByFiletype: function(type){
			var self = this;
			return this.filterLayers_Active.filter(function(lyr){
				return lyr.filetype.toLowerCase() == type && (self.nightMode && lyr.urldark);
			});
		},
		filterLayersByGroup: function(group){
			return this.layers.filter(function(lyr){
				return lyr.groupid === group;
			}).sort(function(a, b){
				return a.grouporderinside - b.grouporderinside;
			});
		},
		
		getLatLng: function(clat, clng){
			return {lat: clat, lng: clng};
		},
		
		getBearingArrow: function(_bearing){
			var _arrow = '↑↑'; //'←'  '→'  '↓  ↖  ↗  ↘  ↙'
			if ( ['N'].indexOf(_bearing) > -1 ){_arrow = '↑↑'}
			if ( ['NNE','NE','ENE'].indexOf(_bearing) > -1 ){_arrow = '↓↗'}
			if ( ['E'].indexOf(_bearing) > -1 ){_arrow = '→→'}
			if ( ['ESE','SE','SSE'].indexOf(_bearing) > -1 ){_arrow = '↓↘'}
			if ( ['S'].indexOf(_bearing) > -1 ){_arrow = '↓↓'}
			if ( ['SSW','SW','WSW'].indexOf(_bearing) > -1 ){_arrow = '↓↙'}
			if ( ['W'].indexOf(_bearing) > -1 ){_arrow = '←←'}
			if ( ['WNW','NW','NNW'].indexOf(_bearing) > -1 ){_arrow = '↓↖'}
			return _arrow.substr(1,1);
		},
		
		/* MAP ICONS & LABELS */
		getVehicleIcon: function(vehicle){
			if (!(vehicle.isrecent)){
				if(!(vehicle.isOpen)){
					return {url: 'vehicles/white1_v1.png', labelOrigin: new google.maps.Point(27,9)};
				}
				else{
					return {url: 'vehicles/gray1_ghost_v1.png', labelOrigin: new google.maps.Point(26,9)};
				}
			}
			else{
				if(vehicle.department == 'POL'){
					if (vehicle.callnumber.length > 5){
						return {url: 'vehicles/blue1_v1_OnACall.png', labelOrigin: new google.maps.Point(26,11)};
					}
					else{
						return {url: 'vehicles/blue1_v1.png', labelOrigin: new google.maps.Point(26,9)};
					}
				}
				else if(vehicle.department == 'FIR'){
					if(vehicle.division1 == 'PREVENTION'){
						return {url: 'vehicles/purple1_v1.png', labelOrigin: new google.maps.Point(26,9)};
					}
					else if (vehicle.callnumber.length > 5){
						return {url: 'vehicles/red1_v1_OnACall.png', labelOrigin: new google.maps.Point(26,11)};
					}
					else{
						return {url: 'vehicles/red1_v1.png', labelOrigin: new google.maps.Point(26,9)};
					}
				}
				else if(vehicle.department == 'ALL'){
					return {url: 'vehicles/dotGreen.png'};
				}
			}
		},
		getVehicleLabel: function(vehicle){
			var vcolor = 'white';
			var vweight = '500';
			if (this.nightMode && !(vehicle.isrecent) && !(vehicle.isOpen)){
				vcolor = '#cccccc';
			}
			else if (!(vehicle.isrecent)){
				vcolor = 'black';
			}
			if (vehicle.department == 'POL' && !(vehicle.onduty)){
				vweight = '300';
			}
			return {
				text: vehicle.label.replace(' (OOS)', ''),
				color: vcolor,
				font: 'Roboto, Arial, sans-serif',
				fontSize: '14px',
				fontWeight: vweight
			};
		},
		getVehicleIndex: function(vehicle){
			var group = 200;
			
			if(vehicle.isOpen){
				return vehicle.openIndex;
			}
			else{
				if (vehicle.isrecent){
					if(vehicle.velocity != 0){
						if(vehicle.callnumber != '' ){
							group = 1600;
						}
						else{
							if(vehicle.division1 != 'PREVENTION'){
								group = 1400;
							}
							else{
								group = 1200;
							}
						}
					}
					else{
						if(vehicle.callnumber != '' ){
							group = 1000;
						}
						else{
							if(vehicle.division1 != 'PREVENTION'){
								group = 800;
							}
							else{
								group = 600;
							}
						}
					}
				}
				return group - vehicle.order;
			}
		},
		getCallIndex: function(call){
			if(call.isOpen){
				return call.openIndex;
			}
			else{
				return 400 - call.order;
			}
		},
		getCallIcon: function(isOpen) {
			var url = 'vehicles/call_v1.png';
			return {
				url: url,
				labelOrigin: new google.maps.Point(25, 5)
			};
		},
		getCallLabel: function(complaint, isnew){
			var vcolor = 'black';
			if(this.nightMode){
				vcolor = '#cccccc';
			}
			return {
				text: complaint,
				fontFamily: 'Roboto, Arial, sans-serif',
				fontSize: '12px',
				fontWeight: '700',
				color: vcolor
			};
		},
		getSearchIcon: function() {
			return {
				url: this.placeInput.place.icon,
				scaledSize: new google.maps.Size(30,30),
				labelOrigin: new google.maps.Point(15, 35)
			};
		},
		getSearchLabel: function(){
			var vcolor = 'black';
			if(this.nightMode){
				vcolor = '#cccccc';
			}
			return {
				text: this.placeInput.place.name,
				fontFamily: 'Roboto, Arial, sans-serif',
				fontSize: '12px',
				fontWeight: '700',
				color: vcolor
			};
		},
		
		/* EVENTS - CLICK */
		clickCenterMap: function(){
			if(app.centerV.lat != app.centerDefault.lat || app.centerV.lng != app.centerDefault.lng){
				//console.log("centerV clickCenterMap");
				app.centerV = app.centerDefault;
			}
			if(app.zoomV != 13){
				//console.log("zoomV clickCenterMap");
				app.zoomV = 13;
			}
			
			return false;
		},
		centerOnCall: function(call){
			if(app.centerV.lat != call.lat2 || app.centerV.lng != call.lng2){
				//console.log("Center on " + call.callnumber);
				app.clickStationNotification(call);
			}
		},
		clickCloseAll: function(){
			this.data.Calls.forEach(function(call){
				call.isOpen = false;
			});
			this.data2.Vehicles.forEach(function(vehicle){
				vehicle.isOpen = false;
			});
			
			this.countOpenIndex = 1600;
			
			return;
		},
		clickRefresh: function(){
			location.reload(true);
			return;
		},
		clickCallMarker: function(call, e){
			var self = this;
			
			//console.log("clickCallMarker");
			if(!(call.isOpen)){
				call.openIndex = self.countOpenIndex + 1;
				self.countOpenIndex++;
				Vue.nextTick(function(){
					self.scrollToCallPanel(call);
				});
			}
			
			return;
		},
		clickCallList: function(call, e){
			var self = this;
			
			//console.log("clickCallList");
			Vue.nextTick(function(){
				if(call.isOpen){
					call.openIndex = self.countOpenIndex + 1;
					self.countOpenIndex++;
					self.centerCallMarker(call);
				}
			});
			
			return;
		},
		clickCallNotification: function(call, e){
			var self = this;
			
			if(!(call.isOpen)){
				call.isOpen = true;
			}
			Vue.nextTick(function(){
				if(call.isOpen){
					call.openIndex = self.countOpenIndex + 1;
					self.countOpenIndex++;
				}
				self.scrollToCallPanel(call);
			});
			//console.log("clickCallNotification");
			self.centerCallMarker(call);
			
			return;
		},
		clickStationNotification: function(callS, e){
		var c = this.filteredCalls.find(function(call){
				return call.callnumber == callS.callnumber;
			});
			
			if(c){
				this.clickCallNotification(c);
			}
			
			return;
		},
		clickNarrativeFeed: function(callnumber){
			var c = this.filteredCalls.find(function(call){
				return call.callnumber == callnumber;
			});
			
			if(c){
				this.clickCallNotification(c);
			}
			
			return;
		},
		clickVehicleMarker: function(vehicle, e){
			var self = this;
			
			if(!(vehicle.isOpen)){
				vehicle.openIndex = self.countOpenIndex + 1;
				self.countOpenIndex++;
			}
			
			return;
		},
		clickVehicleList: function(vehicle, e){
			var self = this;
			
			if(!(vehicle.isOpen)){
				vehicle.isOpen = true;
			}
			Vue.nextTick(function(){
				if(vehicle.isOpen){
					vehicle.openIndex = self.countOpenIndex + 1;
					self.countOpenIndex++;
				}
			});
			this.centerVehicleMarker(vehicle);
			
			return;
		},
		/* FUNCTIONAL */
		goToCallnumber: function(callnumber){
			var c = this.filteredCalls.find(function(call){
				return call.callnumber == callnumber;
			});
			
			if(c){
				this.clickCallNotification(c);
			}
			else{
				this.alertCallNumber = callnumber;
				this.showAlert = true;
			}
			return;
		},
		scrollToCallPanel: function(call){		
			// scroll to panel
			var p = app.$refs.accordion.$children.find(function (panel){
				return panel.$el.id == call.callnumber;
			});
			app.$el.querySelector("#rightSide").scrollTop = p.$el.offsetTop;
			
			return;
		},
		centerCallMarker: function(call){
			// center & zoom to call marker on map
			if( !(!(call.lat) || !(call.lng)) ){
				if(this.station == ''){
					if (this.zoomV < 15){
						//console.log("zoomV centerCallMarker");
						this.zoomV = 15;
					}
				}
				else{
					if (this.zoomV < 17){
						//console.log("zoomV centerCallMarker");
						this.zoomV = 17;
					}
				}
				//console.log("CENTER");
				//console.log("centerV centerCallMarker");
				this.centerV = this.getLatLng(call.lat2, call.lng2);
			}
			return;
		},
		centerVehicleMarker: function(vehicle){
			// center & zoom to vehicle marker on map
			if( !(!(vehicle.lat) || !(vehicle.lng)) ){
				if (this.zoomV < 15){
					//console.log("zoomV centerVehicleMarker");
					this.zoomV = 15;
				}
				//console.log("centerV centerVehicleMarker");
				this.centerV = this.getLatLng(vehicle.lat, vehicle.lng);
			}
			return;
		},
		
		resetAutocomplete: function(){
			var self = this;
			if(this.placeInput.place.id){
				this.placeInputOpen = false;
				this.placeInput.place = {name:''};
				Vue.nextTick(function(){
					self.$refs.gplaceinput.$els.input.value = self.placeInput.place.name;
				});
			}
			return;
		},
		
		addLayerToggleOrder: function(lyr){
			var len;
			var len2;
			
			lyr.isloading = true;
			
			len = this.layersToggleOrder.push(lyr.id);	// add layer's id to array, returns new array length
			this.countActiveLayers++;
			lyr.toggleOrder = len;	 // set layer toggle order (first will be 1)
			
			if(lyr.filetype.toLowerCase() == "mapservice" || lyr.filetype.toLowerCase() == "kml"){
				lyr.active = true;
			}
			if(lyr.filetype.toLowerCase() == "tilecache"){		// || lyr.filetype.toLowerCase() == "wms"){
				len2 = this.layersMapTypeOrder.push(lyr.id);		// [tilecache & wms] add layer's id to array, returns new array length
				lyr.mapTypeIndex = len2 - 1;
				lyr.active = true;
				//console.log("addLayerToggleOrder " + lyr.id + ": toggleOrder " + lyr.toggleOrder + ", mapTypeIndex " + lyr.mapTypeIndex);
			}
		},
		removeLayerToggleOrder: function(lyr){
			//console.log("removeLayerToggleOrder " + lyr.id + ": toggleOrder " + lyr.toggleOrder + ", mapTypeIndex " + lyr.mapTypeIndex);
			var self = this;
			lyr.active = false;
			var i = this.layersToggleOrder.indexOf(lyr.id);		// find layer's id in array (index start at 0)
			var otherID;
			var otherLyr;
			if(i > -1){
				this.layersToggleOrder.splice(i,1)		// remove layer's id from array
				this.countActiveLayers--;
				lyr.toggleOrder = 0;	// set layer's toggle order to 0
				// for each remaining layer in array, find in app.layers, decrement their toggleOrder
				for(i; i < this.layersToggleOrder.length; i++){
					otherID = self.layersToggleOrder[i];
					otherLyr = self.filterLayers_Active.find(function(oLayer){
						return oLayer.id == otherID;
					})
					if(otherLyr){
						otherLyr.toggleOrder--;
					}
				}
				
				if(lyr.filetype.toLowerCase() == "tilecache"){ 		//|| lyr.filetype.toLowerCase() == "wms"){
					var i2 = this.layersMapTypeOrder.indexOf(lyr.id);		// [tilecache & wms] find layer's id in array (index start at 0)
					if(i2 > -1){
						this.layersMapTypeOrder.splice(i2,1)		// [tilecache & wms] remove layer's id from array
						// [tilecache & wms] for each remaining layer in array, find in app.layers, decrement their toggleOrder
						for(i2; i2 < this.layersMapTypeOrder.length; i2++){
							otherID = self.layersMapTypeOrder[i2];
							otherLyr = self.filterLayers_Active.find(function(oLayer){
								return oLayer.id == otherID;
							})
							if(otherLyr){
								otherLyr.mapTypeIndex--;
							}
						}
					}
					else{
						console.log("layer mapTypeIndex not added");
					}
				}
			}
			else{
				console.log("layer toggleOrder not added");
			}
		},

		layerToggle: function(lyr){
			// DECLARE VARIABLES
			if(lyr.filetype.toLowerCase() == "mapservice" || lyr.filetype.toLowerCase() == "tilecache" || lyr.filetype.toLowerCase() == "kml"){
				var self = this;
				
				if(lyr.active === false){
					/*self.countActiveLayers++;
					lyr.toggleOrder = self.countActiveLayers;
					
					if(lyr.filetype.toLowerCase() == "mapservice"){
						lyr.active = true;
					}
					if(lyr.filetype.toLowerCase() == "tilecache"){
						lyr.active = true;
					}
					*/
					this.addLayerToggleOrder(lyr);
					
				}
				else{
					/*lyr.active = false;
					self.countActiveLayers--;
					lyr.toggleOrder = 0;
					*/
					this.removeLayerToggleOrder(lyr);
				}
			}
			return;
		},
		
		loadGISLayers: function(){
			// Uses vue-resource
			// Get layer information from Google Spreadsheet
			var self = this;
			var lyr;
			//this.$http.get("https://spreadsheets.google.com/feeds/list/2PACX-1vQyE6030tRHmh3t5FmoZasNAHLZeO8wZflFK7bCz5FeEe6MqfpTjsTNSB5SzDJCT6oFRH6KC3URGuc1/1/od6/public/values?alt=json").then(
			$.post('https://query.cityoflewisville.com/v2/',{
				webservice : 'AVL/Get GIS Layers ',
				auth_token: localStorage.colAuthToken
			},
			function(data) {
				//Success Callback
				
				/*self.layers = response.body.feed.entry.map(function(obj, i){
					lyr = {};
					Object.keys(obj).forEach(function(x){
						if(x.substr(0,4)=='gsx$' || x=='updated'){
							if(x == 'gsx$infowindowcolumns'){
								lyr[x.replace('gsx$','')] = obj[x].$t.split(",").map(function(obj){return obj.toLowerCase()});
							}
							else{
								lyr[x.replace('gsx$','')] = obj[x].$t;
							}
						}
					});
				*/

				self.layers = data.layers.map(function(obj, i){
					lyr = {};
					Object.keys(obj).forEach(function(x){
						if(x == 'infowindowcolumns'){
							if(obj[x]){
								lyr[x] = obj[x].split(",").map(function(obj){return obj.toLowerCase()});
							}
							else{
								lyr[x] = obj[x];
							}
						}
						else{
							lyr[x] = obj[x];
						}
					});
					
					// Set other properties for each layer object
					lyr.isloading = false;
					lyr.toggleOrder = parseInt(9 + lyr.id);
					lyr.mapservice = {};
					lyr.legend = [];
					
					// Activate layers if open on load is true
					//if(lyr.id == 1005){
					if(lyr.avlopenonload){
						lyr.active = true;
					}
					else{
						lyr.active = false;
					}

					return lyr;
				});
				
				//console.log(self.layers);
			})
			.fail(function(data){
				// error callback
				alert("Error loading GIS Layers - no response from spreadsheet");
			});
		},
		fireSetup: function(){
			var self = this;
			this.loadComplaintAudio();
			switch(this.station.slice(-1)){
				case '1':
					self.centerDefault = {lat: 33.043602, lng: -97.0233208};
					self.stationAudio = 'station one';
					break;
				case '2':
					self.centerDefault = {lat: 33.0449413, lng: -96.9856088};
					self.stationAudio = 'station two';
					break;
				case '3':
					self.centerDefault = {lat: 33.0125507, lng: -96.9913275};
					self.stationAudio = 'station three';
					break;
				case '4':
					self.centerDefault = {lat: 33.0734719, lng: -97.0355181};
					self.stationAudio = 'station four';
					break;
				case '5':
					self.centerDefault = {lat: 33.0125984, lng: -96.9731496};
					self.stationAudio = 'station five';
					break;
				case '6':
					self.centerDefault = {lat: 33.0466656, lng: -96.9292659};
					self.stationAudio = 'station six';
					break;
				case '7':
					self.centerDefault = {lat: 33.0314835, lng: -96.9944059};
					self.stationAudio = 'station seven';
					break;
				default:
					self.stationAudio = 'all stations';
			}
		},
		loadComplaintAudio: function(){
			// Uses vue-resource
			// Get layer information from Google Spreadsheet
			//console.log('loadComplaintAudio');
			var self = this;
			var complaint;
			//this.$http.get("https://spreadsheets.google.com/feeds/list/1DtV1BcT3CBH7uxXXPzbTmFwQY6Npd4wA08z9hYzvROI/1/public/values?&alt=json&sq=complaint%3E%22%22").then(
			$.post('https://query.cityoflewisville.com/v2/',{
				webservice : 'AVL/Get Complaint Audio',
				auth_token: localStorage.colAuthToken
			},
			function(data) {
				console.log("complaintAudio");
				console.log(data);
				//Success Callback
				self.complaintAudio = data.ComplaintAudio;
				self.complaintAudioFound = true;
				
			})
			.fail(function(response){
				// error callback
				//console.log('err');
				setTimeout(function(){app.loadComplaintAudio();}, 10000);
			});
		},
		playStationAlert: function(){
			this.currentlySpeaking = true;
			if(!(this.speechAudio) || !(window.speechSynthesis)){
				this.$els.audio.play();
				setTimeout(function(){app.currentlySpeaking = false;}, 6000);
			}
			else{
				//console.log('playStationAlert ' + this.speechQueue[0].complaint);
				var self = this;
				
				//this.$els.audio.pause();
				//this.$els.audio.currentTime = 0;
				
				if (this.voiceUK =='' || !(this.voiceUK)){
					var v = speechSynthesis.getVoices().filter(function(voice) { return (voice.name.search('UK') > -1); });
					this.voiceUK = v[(v.length-1)];
				}
				if(this.complaintAudioFound){
					while(self.speechQueue.length > 0){
						var call = self.speechQueue.shift();
						//console.log(self.getCallAudio(call));
						var msg = new SpeechSynthesisUtterance();
						msg.text = self.getCallAudio(call);
						msg.voice = self.voiceUK;
						msg.onerror = function(event) { console.log('speech error'); }
						console.log(msg);
						speechSynthesis.speak(msg);
					}
					self.currentlySpeaking = false;
				}
				else{
					setTimeout(function(){console.log('timeout complaints loaded');app.playStationAlert();}, 2000);
				}
			}
		},
		clearStationAlert: function(callnumber){
			var call = this.filteredCalls_Station.find(function(call){
				return call.callnumber == callnumber;
			});
			if(call){
				//console.log('timeout');
				call.showAlert = false;
			}
			return;
		},
		getCallAudio: function(call){
			var self = this;
			var audio = '';
			// get intro string
			if(call.stationUnits2.length == 0){
				audio += this.getNewCallAudio();
				audio += this.getComplaintAudio(call.complaint);
				
				call.stationUnits.forEach(function(unit){
					audio += self.getVehicleAudio(unit) + '. ';
				});
			}
			else{
				audio += this.getNewUnitAudio(call);
				audio += this.getComplaintAudio(call.complaint);
			}
			
			return audio += call.locationaddr.replace(' S ', ' South ').replace(' N ', ' North ').replace(' W ', ' West ').replace(' E ', ' East ') + '.';
		},
		getNewCallAudio: function(){
			return  'New call for ' + this.stationAudio + '. ';
		},
		getNewUnitAudio: function(call){
			var self = this;
			var audio = 'New units assigned for ' + this.stationAudio + '. ';
			call.stationUnits2.forEach(function(unit){
				if(unit.isNew){
					audio += self.getVehicleAudio(unit.unit) + '. ';
				}
			});
			return audio;
		},
		getComplaintAudio: function(complaint){
			var audio = '';
			var cAudio = this.complaintAudio.find(function(c){
				return complaint == c.complaint;
			});
			if(cAudio){
				audio = cAudio.utterance;
			}
			else{
				audio = complaint;
			}
			return audio + '. ';
		},
		getVehicleAudio:function(unit){
			var self = this;
			var audio = '';
			
			var num = unit.match("[0-9][0-9][0-9]")[0];
			
			unit = unit.replace(num, '');
			
			audio += self.getAudioStr(unit) + ' ';
			
			for (var i = 0; i < num.length; i++) {
				if(i != 1){
					audio += self.getAudioStr(num.charAt(i)) + ' ';
				}
				else{
					audio += self.getAudioStr('60') + ' ';
				}
			}
			return audio.trim();
		},
		getAudioStr: function(c){
			var audio = '';
			switch(c){
				case '1':
					audio = 'one';
					break;
				case '2':
					audio = 'two';
					break;
				case '3':
					audio = 'three';
					break;
				case '4':
					audio = 'four';
					break;
				case '5':
					audio = 'five';
					break;
				case '6':
					audio = 'six';
					break;
				case '7':
					audio = 'seven';
					break;
				case '8':
					audio = 'eight';
					break;
				case '9':
					audio = 'nine';
					break;
				case '60':
					audio = 'sixty';
					break;
				case 'E':
					audio = 'Engine';
					break;
				case 'M':
					audio = 'Medic';
					break;
				case 'T':
					audio = 'Truck';
					break;
				case 'R':
					audio = 'Rescue';
					break;
				case 'RE':
					audio = 'Rescue Hazmat';
					break;
				case 'BR':
					audio = 'Brush';
					break;
				case 'BT':
					audio = 'Boat';
					break;
				default:
					audio = c;
			}
			return audio;
		},
		pollingCalls: function(){
			var self = this;
			/*this.$http.post('https://ax1vnode1.cityoflewisville.com/v2/', {
				webservice : 'AVL/Get Calls and Notes',
				ExcludeComplaints: '',
				auth_token: localStorage.colAuthToken
			}).then(*/
			$.post('https://query.cityoflewisville.com/v2/',{
				webservice : 'AVL/Get Calls and Notes',
				ExcludeComplaints: '',
				auth_token: localStorage.colAuthToken
			},
			function(data){
				//console.log(response.data.Calls);
				//console.log(response.data.Notes);
				
				var unitArr;
				var u;
				var checkStation = false;
				
				// initial data
				if(app.data.Calls.length==0){
					app.data = data;
					app.initial1 = true;
					
					app.data.Calls.forEach(function(call){
						Vue.set(call, 'isOpen', false);
						Vue.set(call, 'openIndex', 0);
						unitArr = [];
						if(app.station){
							if(call.unitcount > 0){ // cannot restrict to FIR
								u = call.units.split(", ");
								unitArr = u.filter(function(unit){
									if(app.station=='ALL'){
										return (unit.search("(E|T|M).[0-9]+") == 0);
									}
									else{
										return ( (unit.search("(E|T|M).[0-9]+") == 0) && unit.endsWith(app.station.slice(-1)) );
									}
								});
							}
						}
						Vue.set(call, 'newUnits', []);
						Vue.set(call, 'stationUnits2', []);
						Vue.set(call, 'showAlert', false);
						Vue.set(call, 'alertTimeout', '');
						if(unitArr.length > 0){
							checkStation = true;
							call.isOpen = true;
							
							call.openIndex = app.countOpenIndex + 1;
							app.countOpenIndex++;
						}
						Vue.set(call, 'stationUnits', unitArr);
					});
					// Direct to call number in URL
					if(app.directLinkCall && app.directLinkCall != ''){
						app.goToCallnumber(app.directLinkCall);
					}
				}
				
				// added or changed data
				else{
					data.Calls.forEach(function(call, index){
						unitArr = '';
						var oldCall = app.data.Calls.find(function (c){
							return c.callnumber == call.callnumber;
						});
						if (!oldCall){
							// new call
							call['isOpen'] = false;
							call['openIndex'] = 0;
							unitArr = [];
							if(app.station){
								if(call.unitcount > 0){ // cannot restrict to FIR
									u = call.units.split(", ");
									unitArr = u.filter(function(unit){
										if(app.station=='ALL'){
											return (unit.search("(E|T|M).[0-9]+") == 0);
										}
										else{
											return ( (unit.search("(E|T|M).[0-9]+") == 0) && unit.endsWith(app.station.slice(-1)) );
										};
									});
								}
							}
							call['newUnits'] = [];
							call['stationUnits2'] = [];
							call['showAlert'] = false;
							call['alertTimeout'] = '';
							if(unitArr.length > 0){
								checkStation = true;
								call.isOpen = true;
								
								call.openIndex = app.countOpenIndex + 1;
								app.countOpenIndex++;
							}
							call['stationUnits'] = unitArr;
						}
						else{
							// if units were changed
							call['isOpen'] = oldCall.isOpen;
							call['openIndex'] = oldCall.openIndex;
							
							if(call.units.toString() !== oldCall.units.toString()){
								unitArr = [];
								if(app.station){
									if(call.unitcount > 0){	 // cannot restrict to FIR	
										//console.log("Change: " + call.units);
										u = call.units.split(", ");
										unitArr = u.filter(function(unit){
											if(app.station=='ALL'){
												return (unit.search("(E|T|M).[0-9]+") == 0);
											}
											else{
												return ( (unit.search("(E|T|M).[0-9]+") == 0) && unit.endsWith(app.station.slice(-1)) );
											}
										});
									}
								}
								call['stationUnits'] = unitArr;
								if(unitArr.length > 0){
									checkStation = true;
									if(!(call.isOpen)){
										call.isOpen = true;
									}
									call.openIndex = app.countOpenIndex + 1;
									app.countOpenIndex++;
								}
								else{
									if(app.station){
										call.isOpen = false;
										call.openIndex = 0;
									}
								}
							}
							// old call, copy over prev. set properties
							else{
								call['stationUnits'] = oldCall.stationUnits;
							}
							call['newUnits'] = oldCall.newUnits;
							call['stationUnits2'] = oldCall.stationUnits2;
							call['showAlert'] = oldCall.showAlert;
							call['alertTimeout'] = oldCall.alertTimeout;
						}
					});
						
					app.data.Calls = data.Calls;
					app.data.Notes = data.Notes;
				
					Vue.nextTick(function(){
						// Direct to call number in URL
						
						if(checkStation){
							app.filteredCalls_Station = app.data.Calls.filter(function(call){
								return (call.unitcount > 0 && call.stationUnits.length > 0); // cannot restrict to FIR
							}).map(function(call, index){
								return {callnumber: call.callnumber, complaint:call.complaint, location:call.locationaddr, stationUnits: call.stationUnits};
							});
						}
					});
				}
					
				app.callsPolling = true;
				if (app.callsPollingSec != 'OFF'){
					setTimeout(app.pollingCalls, app.callsPollingMS);
				}
			})
			.fail(function(data){
				console.log("calls polling failed");
				app.callsPolling = false;
				if (app.callsPollingSec != 'OFF'){
					setTimeout(app.pollingCalls, app.callsPollingMS);
				}
			});		
		},
		pollingVehicles: function(){
			var self = this;
			/*this.$http.post('https://ax1vnode1.cityoflewisville.com/v2/', {
				webservice : 'AVL/Get Vehicles',
				auth_token: localStorage.colAuthToken
			}).then(*/
			$.post('https://query.cityoflewisville.com/v2/',{
				webservice : 'AVL/Get Vehicles',
				auth_token: localStorage.colAuthToken
			},
			function(data){
				//console.log(response.data.Vehicles);		
				data.Vehicles.forEach(function(vehicle, index){
					var i = app.data2.Vehicles.findIndex(function (v){
						return v.modemid == vehicle.modemid;
					});
					if (i == -1){
						vehicle['isOpen'] = false;
						vehicle['openIndex'] = 0;
					}
					else{
						vehicle['isOpen'] = app.data2.Vehicles[i].isOpen;
						vehicle['openIndex'] = app.data2.Vehicles[i].openIndex;
					}
				});
				
				app.data2.Vehicles = data.Vehicles;
				app.initial2 = true;
				app.vehiclesPolling = true;
				if (app.vehiclesPollingSec != 'OFF'){
					setTimeout(app.pollingVehicles, app.vehiclesPollingMS);
				}
			})
			.fail(function(data){
				console.log("vehicles polling failed");
				app.vehiclesPolling = false;
				if (app.vehiclesPollingSec != 'OFF'){
					setTimeout(app.pollingVehicles, app.vehiclesPollingMS);
				}
			});
		},
	},
	ready: function() {
		console.log('AVL 3.4 Polling Version updated 9/20/18 for Google Maps 3.32 - Vehicles polling every 1 second');
		
		// Solution: https://github.com/vuejs/vue/issues/1915
		window.addEventListener('resize', this.handleResize);
		//window.addEventListener('mapIdling', this.handleResize);
		var self = this;
		
		this.pollingCalls();
		this.pollingVehicles();
		
		if(window.speechSynthesis){
			var v = speechSynthesis.getVoices().filter(function(voice) { return (voice.name.search('UK') > -1); });
			this.voiceUK = v[(v.length-1)];
		}
		
		if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent) 
					|| /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))
		){
			self.isMobile = true;
		}
		self.isAndroid = navigator.userAgent.toLowerCase().indexOf("android") > -1; //&& ua.indexOf("mobile");
		
		var initialParams = location.hash;
		
		if (initialParams != ""){
			var match;
			
			// Views
			
			match = RegExp('view=([^&]*)').exec(initialParams);
			if ( match && match[1] == 'map' ){
				self.radioValue = 'Map';
			}
			else if ( match && match[1] == 'list' ){
				self.radioValue = 'List';
			}
			
			match = RegExp('narrative').exec(initialParams);
			if (match){
				self.showNarrative = true;
			}
			match = RegExp('layers').exec(initialParams);
			if (match){
				// check if user has incorrect params: either layers OR vehicles - cannot be both
				match2 = RegExp('vehicles').exec(initialParams);
				if (match2){
					self.showVehicles = true;
				}
				else{
					self.showGIS = true;
				}
			}
			else{
				match = RegExp('vehicles').exec(initialParams);
				if (match){
					self.showVehicles = true;
				}
			}
			
			// Options
			
			match = RegExp('traffic').exec(initialParams);
			if (match){
				self.showTrafficLayer = true;
			}
			
			// Filters
			
			match = RegExp('department=([^&]*)').exec(initialParams);
			if ( match &&  match[1] == 'police' ){
				self.department = 'POL';
			}
			if ( match &&  match[1] == 'fire' ){
				self.department = 'FIR';
			}
			match = RegExp('xp9').exec(initialParams);
			if (match){
				self.showP9 = false;
			}
			match = RegExp('station=([^&]*)').exec(initialParams);
			if(match){
				self.station = match[1].toUpperCase();
				self.setNight = 'AUTO';
				self.fireSetup();
			}
			
			match = RegExp('night=([^&]*)').exec(initialParams);
			if (match){
				self.setNight = match[1].toUpperCase();
			}
			
			match = RegExp('speech').exec(initialParams);
			if (match){
				self.speechAudio = true;
			}
			
			match = RegExp('developer').exec(initialParams);
			if (match){
				self.devITS = true;
			}
			/*
			match = RegExp('callpoll=([^&]*)').exec(initialParams);
			if (match){
				self.callsPollingSec = match[1].toUpperCase();
			}
			match = RegExp('vehiclepoll=([^&]*)').exec(initialParams);
			if (match){
				self.vehiclesPollingSec = match[1].toUpperCase();
			}
			*/
			
			// Get call number for direct link
			match = RegExp('callnumber=([^&]*)').exec(initialParams);
			if(match){
				self.directLinkCall = match[1];
				location.hash = initialParams.slice(1).replace(/(&*)callnumber=([^&]*)/, '')
			}
			
		}
		
		
		// Add watches after the initial set from URL parameters
		// Wait, why not on the inital set??? - 4/27
		
		self.$watch('radioValue', function(newVal, oldVal){
/* UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 */
			//console.log("radioValue");
//comment out			self.$broadcast('g-resize-map');
		})
		self.$watch('showNarrative', function(newVal, oldVal){
			//console.log("showNarrative");
/* UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 */
//comment out			self.$broadcast('g-resize-map');
		})
		self.$watch('showGIS', function(newVal, oldVal){
			//console.log("showGIS");
/* UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 */
//comment out			self.$broadcast('g-resize-map');
			
			if(newVal && self.showVehicles){
				self.showVehicles = !(self.showVehicles);
			}
		})
		self.$watch('showVehicles', function(newVal, oldVal){
/* UPDATE FOR Google Maps V3.32 - CLarson 8/10/18 */
			//console.log("showVehicles");
//comment out			self.$broadcast('g-resize-map');
			if(newVal && self.showGIS){
				self.showGIS = !(self.showGIS);
			}
		})

		
		// Add watch to currentRoute to update hash for future changes
		self.$watch('currentRoute', function(newVal, oldVal){
			//console.log("currentRoute");
			location.hash = newVal;
		})
		
		// Uses vue-resource
		// Get layer information from Google Spreadsheet
		this.loadGISLayers();
			
		VueGoogleMap.loaded.then(function(map) {
			//console.log('the google map library has been loaded');
			self.mapLoaded = true;
		})
	},
	 beforeDestroy: function () {
		window.removeEventListener('resize', this.handleResize);
	},
});



// When vue google maps loads, vueGoogleMapsInit is the callback
// Add arcgis, then callback arcGISInit
// vue-google-maps.js file is modified to resolve the promise after window.arcGISInit
var vueGoogleMapsInit = function(){
	//console.log("vueGoogleMapsInit");
	var script = document.createElement( "script" );
	script.type = "text/javascript";
	if(script.readyState) {  //IE
		script.onreadystatechange = function() {
			if ( script.readyState === "loaded" || script.readyState === "complete" ) {
				script.onreadystatechange = null;
				arcGISInit();
			}
		};
	}
	else {  //Others
		script.onload = function() {
			arcGISInit();
		};
	}
	script.src = 'scripts/arcgislink3.32_8-17.js';
	document.body.appendChild( script );
}

</script>

</body>
</html>